# RTAB-Map SLAM Module Configuration
# Optimized for NVIDIA Jetson AGX Orin with ZED 2i stereo camera

mode:
  localization: false           # false=SLAM mode, true=localization mode
  delete_db_on_start: false     # Set true to start fresh mapping

database:
  path: "~/.ros/rtabmap.db"     # Map database location

frames:
  base_link: "base_link"        # Robot base frame
  odom: "odom"                  # Odometry frame
  map: "map"                    # Global map frame

topics:
  # ZED 2i stereo camera topics
  left_image: "/zed2i/zed_node/left/image_rect_color"
  right_image: "/zed2i/zed_node/right/image_rect_gray"
  left_camera_info: "/zed2i/zed_node/left/camera_info"
  right_camera_info: "/zed2i/zed_node/right/camera_info"
  odom: "/zed2i/zed_node/odom"  # Use ZED's visual odometry
  imu: "/zed2i/zed_node/imu/data"

rtabmap:
  queue_size: 30                # Large queue for stereo sync
  approx_sync: true             # Approximate time synchronization
  approx_sync_max_interval: 0.01  # 10ms sync tolerance

slam:
  detection_rate: 1             # Loop closure detection rate (Hz), 0=unlimited
  time_threshold: 0             # Max time for map update (ms), 0=disabled

memory:
  # Memory optimization for Jetson (32GB RAM)
  image_kept: 0                 # Don't store images in RAM (save memory)
  stm_size: 10                  # Short-term memory size (recent nodes)
  reduce_graph: 0.0             # Don't reduce graph (keep all nodes)

loop_closure:
  # Loop closure detection settings
  reextract_features: true      # Re-extract features for loop closure
  min_inliers: 15               # Minimum inliers for loop closure
  inlier_distance: 5            # Maximum inlier distance (pixels)

optimization:
  max_error: 3                  # Maximum optimization error
  proximity_by_space: true      # Use spatial proximity for constraints

performance:
  # Reduced for Jetson performance (balance speed vs accuracy)
  max_features: 400             # Maximum visual features per frame
  hessian_threshold: 150        # SURF feature detection threshold

# 2D Grid Map Generation for Nav2
grid:
  from_depth: true              # Generate grid from depth data
  cell_size: 0.05               # 5cm resolution (meters)
  range_max: 5.0                # Maximum range for obstacles (meters)
  range_min: 0.0                # Minimum range
  cluster_radius: 1.0           # Cluster radius for obstacle grouping
  ground_is_obstacle: false     # Floor is not an obstacle
  max_obstacle_height: 2.0      # Objects above 2m are ignored
  max_ground_height: 0.1        # Objects below 10cm are floor
  normals_segmentation: true    # Use normal-based segmentation
  3d: false                     # Generate 2D grid (not 3D)
  noise_filtering_radius: 4     # Noise filter radius (cells)
  noise_filtering_min_neighbors: 5  # Min neighbors to keep cell

# Advanced RTAB-Map parameters (applied via parameter overrides)
# These can be uncommented and customized as needed:

# visual_odometry:
#   enabled: false               # Use ZED odom instead of RTAB-Map VO
#   min_inliers: 20
#   iterations: 100

# optimization:
#   iterations: 10
#   epsilon: 0.0001
#   robust: true

# Notes:
# - This config uses ZED 2i's stereo images for SLAM
# - ZED's built-in visual odometry is used (more reliable than RTAB-Map's)
# - Memory settings optimized to prevent OOM on Jetson
# - Feature count reduced for real-time performance
# - Database grows over time - monitor disk space for long missions
# - 2D grid map is published to /rtabmap/grid_map and relayed to /map for Nav2
